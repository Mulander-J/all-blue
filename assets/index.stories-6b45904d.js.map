{"version":3,"file":"index.stories-6b45904d.js","sources":["../../src/stories/@reproduce/TabSync/utils.js","../../src/stories/@reproduce/TabSync/TabSync.svelte"],"sourcesContent":["/** 初始化元素坐标 */\nexport function initElementCoords() {\n    /** 元素宽度 */\n    let elementW = block.clientWidth;\n\n    /** 元素高度 */\n    let elementH = block.clientHeight;\n\n    /** 页面宽度 */\n    let windowW = window.innerWidth;\n\n    /** 页面高度 */\n    let windowH = window.innerHeight;\n\n    return {\n        x: Math.round(windowW / 2 - elementW / 2),\n        y: Math.round(windowH / 2 - elementH / 2)\n    }\n}\n\n/* 当前位置重置 */\nexport function initEvtCoords(ev) {\n    let { pageX, pageY, screenX, screenY } = ev;\n\n    let offsetX = 0,\n        offsetY = 0;\n    let relativeX = screenX - window.screenLeft;\n    let relativeY = screenY - window.screenTop;\n\n    while (relativeX > pageX) {\n        offsetX++;\n        relativeX--;\n    }\n\n    while (relativeY > pageY) {\n        offsetY++;\n        relativeY--;\n    }\n\n    return [offsetX, offsetY]\n}\n\n/**\n * @description 转换坐标值\n * @param {'p2s'|'s2p'} type\n * @param {object} coords\n * @param {number} coords.x\n * @param {number} coords.y\n * @param {array} offsets\n */\nexport function convertCoords(type, coords, offsets) {\n    let { x, y } = coords;\n    let { screenLeft, screenTop } = window;\n    let [offsetX, offsetY] = offsets\n\n    switch (type) {\n        // 页面坐标 -> 屏幕坐标\n        case 'p2s':\n            return {\n                x: x + screenLeft + offsetX,\n                y: y + screenTop + offsetY,\n            };\n        // 屏幕坐标 -> 页面坐标\n        case 's2p':\n            return {\n                x: x - screenLeft - offsetX,\n                y: y - screenTop - offsetY,\n            };\n        default:\n            console.error('转换失败：类型错误');\n            return { x: 0, y: 0 };\n    }\n}\n\n/**\n * @description 解析广播消息\n * @param   {MessageEvent<ChannelMessage>} event\n * @returns {ChannelMessage}\n */\nexport function parseChannelMessage(event) {\n    let data = event.data;\n\n    if (data && data.type) {\n        return data;\n    } else {\n        return {\n            type: '',\n            data: null,\n        };\n    }\n}","<script>\n  import { onMount } from \"svelte\";\n  import {\n    initElementCoords,\n    initEvtCoords,\n    convertCoords,\n    parseChannelMessage,\n  } from \"./utils\";\n  import \"./index.css\";\n\n  let btnElement;\n  let blockElement;\n\n  let channel = new BroadcastChannel(\"DataTransfer\");\n\n  let offsetX = 0;\n  let offsetY = 0;\n\n  function handleAdjustOffset(data) {\n    console.log(\"[AdjustOffset]\", data);\n\n    offsetX = data.x;\n    offsetY = data.y;\n\n    if (btnElement) {\n      btnElement.remove();\n    }\n  }\n  function handleSetDomCoords(data) {\n    let { x, y } = data;\n    blockElement.style.left = x + \"px\";\n    blockElement.style.top = y + \"px\";\n  }\n  function handleUpdateCoords(data) {\n    let _data = convertCoords(\"s2p\", data, [offsetX, offsetY]);\n    handleSetDomCoords(_data);\n  }\n\n  function onMouseDown(downEvent) {\n    /** 元素相对于屏幕的坐标 */\n    let elementCoords = convertCoords(\n      \"p2s\",\n      {\n        x: parseInt(blockElement.style.left),\n        y: parseInt(blockElement.style.top),\n      },\n      [offsetX, offsetY]\n    );\n\n    /** 元素起始水平坐标 */\n    let elementX = elementCoords.x;\n\n    /** 元素起始垂直坐标 */\n    let elementY = elementCoords.y;\n\n    /** 鼠标起始水平坐标 */\n    let cursorX = downEvent.screenX;\n\n    /** 鼠标起始垂直坐标 */\n    let cursorY = downEvent.screenY;\n\n    /**\n     * @description 处理鼠标移动\n     * @param {MouseEvent} moveEvent\n     */\n    let handleMove = function (moveEvent) {\n      let newX = elementX + (moveEvent.screenX - cursorX);\n      let newY = elementY + (moveEvent.screenY - cursorY);\n\n      let coords = { x: newX, y: newY };\n\n      // 更新当前页面元素坐标\n      handleUpdateCoords(coords);\n\n      // 通知其他页面\n      channel.postMessage({\n        type: \"UpdateCoords\",\n        data: coords,\n      });\n    };\n\n    let handleUp = function () {\n      window.removeEventListener(\"mousemove\", handleMove);\n      window.removeEventListener(\"mouseup\", handleUp);\n    };\n\n    window.addEventListener(\"mousemove\", handleMove);\n    window.addEventListener(\"mouseup\", handleUp);\n  }\n\n  const handleInit = function (ev) {\n    const [offsetX, offsetY] = initEvtCoords(ev);\n    // 更新当前页面数据\n    handleAdjustOffset({\n      x: offsetX,\n      y: offsetY,\n    });\n\n    // 通知其他页面更新数据\n    channel.postMessage({\n      type: \"AdjustOffset\",\n      data: { x: offsetX, y: offsetY },\n    });\n\n    // 获取元素相对于屏幕的坐标，用于同步其他页面\n    let coords = convertCoords(\n      \"p2s\",\n      {\n        x: parseInt(blockElement.style.left),\n        y: parseInt(blockElement.style.top),\n      },\n      [offsetX, offsetY]\n    );\n\n    // 更新当前页面元素的坐标\n    handleUpdateCoords(coords);\n\n    // 通知其他页面更新元素坐标\n    channel.postMessage({\n      type: \"UpdateCoords\",\n      data: coords,\n    });\n  };\n\n  onMount(() => {\n    // focus dom elements\n    btnElement.focus();\n    blockElement.focus();\n\n    // init coords\n    const coords = initElementCoords();\n    handleSetDomCoords(coords);\n\n    // channel broadcast\n    channel.addEventListener(\"message\", function (ev) {\n      let { data, type } = parseChannelMessage(ev);\n\n      switch (type) {\n        case \"AdjustOffset\":\n          handleAdjustOffset(data);\n          break;\n        case \"UpdateCoords\":\n          handleUpdateCoords(data);\n          break;\n        default:\n          break;\n      }\n    });\n  });\n</script>\n\n<div style=\"min-height: 500px; width:100%;\">\n  <div\n    id=\"block\"\n    class=\"block\"\n    role=\"none\"\n    bind:this={blockElement}\n    on:mousedown={onMouseDown}\n    style=\"left: 0px; top: 0px;\"\n  />\n  <div\n    id=\"init-btn\"\n    class=\"init-btn\"\n    role=\"none\"\n    bind:this={btnElement}\n    on:click={handleInit}\n  >\n    <span>Initial</span>\n  </div>\n</div>\n"],"names":["initElementCoords","elementW","elementH","windowW","windowH","initEvtCoords","ev","pageX","pageY","screenX","screenY","offsetX","offsetY","relativeX","relativeY","convertCoords","type","coords","offsets","x","y","screenLeft","screenTop","parseChannelMessage","event","data","insert","target","div2","anchor","append","div0","div1","ctx","btnElement","blockElement","channel","handleAdjustOffset","handleSetDomCoords","$$invalidate","handleUpdateCoords","_data","onMouseDown","downEvent","elementCoords","elementX","elementY","cursorX","cursorY","handleMove","moveEvent","newX","newY","handleUp","handleInit","onMount","$$value"],"mappings":"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"}